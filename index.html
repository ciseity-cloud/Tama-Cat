<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tama‑Cat v4.1</title>
<style>
  body {
    background: #050608;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: monospace;
    color: #eee;
  }

  .device {
    background: #222;
    border: 8px solid #666;
    border-radius: 30px;
    padding: 16px;
    width: 340px;
    box-shadow: 0 0 25px #000 inset, 0 0 14px #000;
  }

  #name-box {
    margin-bottom: 6px;
    font-size: 11px;
  }

  input {
    background: #111;
    border: 1px solid #444;
    color: #eee;
    padding: 2px 4px;
    width: 140px;
    font-size: 11px;
  }

  .screen {
    background: #c8f7c8;
    color: #000;
    border: 4px solid #333;
    border-radius: 4px;
    padding: 4px;
    height: 190px;
    box-shadow: 0 0 8px #000 inset;
    display: flex;
    flex-direction: column;
  }

  .screen-top {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .screen-top pre {
    margin: 0;
    font-size: 12px;
    line-height: 12px;
  }

  .screen-bottom {
    height: 50px;
    font-size: 11px;
    line-height: 12px;
    padding-top: 2px;
    white-space: normal;
    overflow: hidden;
  }

  .stats {
    font-size: 11px;
    margin-top: 6px;
    white-space: pre;
  }

  .buttons {
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 4px;
  }

  button {
    flex: 1 1 30%;
    min-width: 70px;
    height: 26px;
    background: #444;
    border: 2px solid #777;
    border-radius: 6px;
    color: #eee;
    font-size: 10px;
    cursor: pointer;
  }

  button:hover {
    background: #555;
  }

  button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  #log {
    margin-top: 6px;
    font-size: 10px;
    height: 46px;
    overflow-y: auto;
    white-space: normal;
  }
</style>
</head>
<body>

<div class="device">
  <div id="name-box">
    Name: <input id="name-input" placeholder="Mochi">
    <button id="start-btn">Start</button>
  </div>

  <div class="screen">
    <div class="screen-top" id="screen-top"></div>
    <div class="screen-bottom" id="screen-bottom"></div>
  </div>

  <div class="stats" id="stats"></div>

  <div class="buttons">
    <button id="feed">Feed</button>
    <button id="play">Play</button>
    <button id="clean">Clean</button>
    <button id="nap">Nap</button>
    <button id="med">Med</button>
  </div>

  <div id="log"></div>
</div>

<script>
/* ---------------- ASCII ART ---------------- */
const art = {
  idle: ` /\\_/\\
( o.o )
 > ^ <`,
  sleepy: ` /\\_/\\
(-.- ) zZ
 > ^ <`,
  happy: ` /\\_/\\
( ^.^ )
 > ^ <`,
  angry: ` /\\_/\\
( >.< )
 > ^ <`,
  hungry: ` /\\_/\\
( ;.; )
 > ^ <`,
  dirty: ` /\\_/\\
( o.o ) ~
 > ^ <`,
  full: ` /\\_/\\
( -w- )
 > ^ <`,
  sick: ` /\\_/\\
( x.x )
 > ^ <`,
  lonely: ` /\\_/\\
( ; _ ; )
 > ^ <`,
  excited: ` /\\_/\\
( ^o^ )
 > ^ <`,
  mischief: ` /\\_/\\
( ^_^ )
 > v <`,
  dead: ` /\\_/\\
(x_x )
 > ^ <`
};

/* ---------------- DIALOGUE ---------------- */
const dialog = {
  idle: [
    "Your tiny cat blinks slowly at you.",
    "It seems content just existing next to you.",
    "The room is quiet, except for a soft imaginary purr."
  ],
  hungry: [
    "A tiny stomach growls in the void.",
    "Those eyes say: 'Snack time. Again.'",
    "It stares at you, then the food bowl, then you."
  ],
  full: [
    "Too many snacks. Regrets are meowed softly.",
    "It waddles a bit when it walks. Still cute.",
    "You may have created a round creature."
  ],
  dirty: [
    "Dust clings to its fur like bad decisions.",
    "It really needs a bath. Or a brush. Or both.",
    "You can almost see cartoon stink lines."
  ],
  sleepy: [
    "Its head keeps drooping like a closing laptop.",
    "It blinks slowly, then stays halfway shut.",
    "You can practically hear the tiny yawns."
  ],
  happy: [
    "Purr level: legendary.",
    "Its tail flicks in little arcs of joy.",
    "This is one extremely pleased little being."
  ],
  angry: [
    "Tail flick: annoyed. Ears: mildly offended.",
    "It gives you the side-eye of judgment.",
    "Someone is one step away from tiny chaos."
  ],
  sick: [
    "Your cat looks woozy. Definitely not okay.",
    "Its eyes look dull. Needs help.",
    "This is not regular sleepy. Something's wrong."
  ],
  lonely: [
    "It looks around like it expected you sooner.",
    "That slow blink feels a little sad today.",
    "It curls tighter, like it's trying to be its own company."
  ]
};

/* ---------------- CAT STATE ---------------- */
let cat = {
  name: "Mochi",
  hunger: 50,
  energy: 50,
  happiness: 50,
  cleanliness: 50,
  sick: false,
  alive: false,
  lastCheck: Date.now(),
  isNapping: false,
  napStart: null
};

/* Persistent history */
let history = [];

const DECAY_CHUNK_MINUTES = 10;

/* ---------------- UTIL ---------------- */
function save() {
  localStorage.setItem("tamaCat", JSON.stringify(cat));
  localStorage.setItem("tamaCatHistory", JSON.stringify(history));
}

function load() {
  const data = localStorage.getItem("tamaCat");
  const hist = localStorage.getItem("tamaCatHistory");

  if (data) cat = JSON.parse(data);
  if (hist) history = JSON.parse(hist);
}

function logMsg(msg) {
  const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const entry = `[${timestamp}] ${msg}`;

  history.unshift(entry);
  if (history.length > 200) history.pop();

  document.getElementById("log").innerHTML = history.join("<br>");
  save();
}

function beep(freq = 800, duration = 120) {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "square";
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
    osc.stop(ctx.currentTime + duration / 1000);
  } catch (e) {}
}

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* ---------------- RENDER ---------------- */
function getMoodAndArt() {
  if (!cat.alive) return { art: art.dead, mood: "dead" };
  if (cat.isNapping) return { art: art.sleepy, mood: "napping" };
  if (cat.sick) return { art: art.sick, mood: "sick" };

  if (cat.happiness < 20) return { art: art.lonely, mood: "lonely" };
  if (cat.hunger < 20) return { art: art.hungry, mood: "hungry" };
  if (cat.cleanliness < 20) return { art: art.dirty, mood: "dirty" };
  if (cat.energy < 20) return { art: art.sleepy, mood: "sleepy" };
  if (cat.hunger > 85) return { art: art.full, mood: "full" };
  if (cat.happiness > 80) return { art: art.happy, mood: "happy" };

  if (cat.happiness >= 50 && cat.energy >= 40) {
    const r = Math.random();
    if (r < 0.15) return { art: art.excited, mood: "happy" };
    if (r < 0.30) return { art: art.mischief, mood: "happy" };
  }

  return { art: art.idle, mood: "idle" };
}

function render() {
  const screenTop = document.getElementById("screen-top");
  const screenBottom = document.getElementById("screen-bottom");
  const stats = document.getElementById("stats");

  const { art: artState, mood } = getMoodAndArt();

  // Centered ASCII cat
  screenTop.innerHTML = "<pre>" + artState + "</pre>";

  // Nap override
  if (cat.isNapping && cat.alive) {
    screenBottom.textContent = cat.name + " is napping...";
  }
  // Dead override
  else if (mood === "dead") {
    screenBottom.textContent = cat.name + " is gone...";
  }
  // Sick override
  else if (mood === "sick") {
    screenBottom.textContent = randomChoice(dialog.sick);
  }
  // Normal mood dialogue
  else if (dialog[mood]) {
    screenBottom.textContent = randomChoice(dialog[mood]);
  }
  // Fallback
  else {
    screenBottom.textContent = randomChoice(dialog.idle);
  }

  // Stats panel
  stats.textContent =
    `Hunger:      ${cat.hunger}
Energy:      ${cat.energy}
Happiness:   ${cat.happiness}
Cleanliness: ${cat.cleanliness}
Sick:        ${cat.sick ? "YES" : "NO"}`;

  // Disable actions while napping or dead
  const disable = cat.isNapping || !cat.alive;
  document.getElementById("feed").disabled = disable;
  document.getElementById("play").disabled = disable;
  document.getElementById("clean").disabled = disable;
  document.getElementById("med").disabled = disable;

  // Nap button toggles label
  document.getElementById("nap").textContent = cat.isNapping ? "Wake" : "Nap";

  // Nap button only disabled if dead
  document.getElementById("nap").disabled = !cat.alive;
}

/* ---------------- TIME DECAY + NAP RECOVERY ---------------- */
function applyTimeDecay() {
  const now = Date.now();
  const diffMinutes = Math.floor((now - cat.lastCheck) / (1000 * 60));

  if (diffMinutes <= 0) return;

  let chunks = Math.floor(diffMinutes / DECAY_CHUNK_MINUTES);
  if (chunks < 1) chunks = 1;

  if (!cat.isNapping) {
    cat.hunger -= 4 * chunks;
    cat.energy -= 3 * chunks;
    cat.cleanliness -= 3 * chunks;
    cat.happiness -= 3 * chunks;
  }

if (cat.isNapping && cat.napStart) {
  const napMinutes = Math.floor((now - cat.napStart) / (1000 * 60));

  // Energy gain: 10 minutes = +50 energy
  const energyGain = Math.floor(napMinutes / 10) * 50;

  // NEW: Per-minute nap drain
  const hungerDrain = napMinutes * 1;        // -1 hunger per minute
  const cleanDrain  = napMinutes * 2;        // -2 cleanliness per minute

  if (napMinutes > 0) {
    // Apply gains + drains
    cat.energy += energyGain;
    cat.hunger -= hungerDrain;
    cat.cleanliness -= cleanDrain;

    // Reset nap timer
    cat.napStart = now;

    logMsg(
      `${cat.name} slept for ${napMinutes} min: +${energyGain} energy, `
      + `-${hungerDrain} hunger, -${cleanDrain} cleanliness.`
    );
  }

  // Cap energy
  if (cat.energy >= 100) {
    cat.energy = 100;
    cat.isNapping = false;
    logMsg(cat.name + " wakes up fully rested.");
    beep(900, 120);
  }
}

  if (diffMinutes >= 60 && !cat.isNapping) {
    cat.sick = true;
    logMsg("Your cat felt ignored for a long time and became sick.");
    beep(500, 200);
  }

  cat.lastCheck = now;
  clamp();
  checkAlive();
}

/* ---------------- SICKNESS ---------------- */
function sicknessCheck() {
  if (cat.hunger > 95) {
    cat.sick = true;
    logMsg(cat.name + " overate and feels sick.");
    beep(400, 200);
  }
  if (cat.cleanliness < 10) {
    cat.sick = true;
    logMsg(cat.name + " is sick from being too dirty.");
    beep(400, 200);
  }
  if (cat.energy < 5) {
    cat.sick = true;
    logMsg(cat.name + " is sick from exhaustion.");
    beep(400, 200);
  }
}

/* ---------------- HELPERS ---------------- */
function clamp() {
  ["hunger","energy","happiness","cleanliness"].forEach(k => {
    cat[k] = Math.max(0, Math.min(100, cat[k]));
  });
}

function checkAlive() {
  if (cat.hunger <= 0 || cat.energy <= 0 || cat.happiness <= 0) {
    if (cat.alive) {
      logMsg(cat.name + " has passed away...");
      beep(200, 400);
    }
    cat.alive = false;
  }
}

/* ---------------- ACTIONS ---------------- */
function actFeed() {
  if (!cat.alive) return;
  cat.hunger += 18;
  cat.happiness += 4;
  clamp();
  logMsg("You feed " + cat.name + ". Tiny crunch sounds ensue.");
  beep(900, 80);
  sicknessCheck();
  tick();
}

function actPlay() {
  if (!cat.alive) return;
  cat.energy -= 12;
  cat.happiness += 15;
  cat.hunger -= 5;
  clamp();
  logMsg(cat.name + " goes wild with zoomies.");
  beep(1000, 80);
  sicknessCheck();
  tick();
}

function actClean() {
  if (!cat.alive) return;
  cat.cleanliness += 25;
  cat.happiness += 6;
  clamp();
  logMsg("You groom " + cat.name + " until the fur shines.");
  beep(850, 80);
  sicknessCheck();
  tick();
}

function actNap() {
  if (!cat.alive) return;

// If already napping → cancel nap
if (cat.isNapping) {
  cat.isNapping = false;
  cat.napStart = null;

  logMsg(cat.name + " wakes up early from the nap.");
  beep(950, 120);

  clamp();
  sicknessCheck();

  tick();     // updates stats + saves
  render();   // <-- forces immediate face update

  return;
}

  // Start a new nap
  cat.isNapping = true;
  cat.napStart = Date.now();

  logMsg(cat.name + " curls up and begins a long nap.");
  beep(700, 80);

  cat.happiness += 3;
  cat.hunger -= 3;
  clamp();
  sicknessCheck();
  tick();
}


function actMed() {
  if (!cat.alive) return;
  if (!cat.sick) {
    logMsg(cat.name + " doesn't need medicine right now.");
    return;
  }
  cat.sick = false;
  cat.happiness += 10;
  clamp();
  logMsg("You give " + cat.name + " medicine. It looks better already.");
  beep(1100, 120);
  tick();
}

/* ---------------- TICK & INIT ---------------- */
function tick() {
  cat.lastCheck = Date.now();
  checkAlive();
  save();
  render();
}

function startGame() {
  cat.name = document.getElementById("name-input").value.trim() || "Mochi";
  cat.hunger = 50;
  cat.energy = 50;
  cat.happiness = 50;
  cat.cleanliness = 50;
  cat.sick = false;
  cat.alive = true;
  cat.isNapping = false;
  cat.napStart = null;
  cat.lastCheck = Date.now();
  save();
  render();
  logMsg(cat.name + " wakes up in the tiny screen.");
  beep(1000, 100);
}

/* Buttons */
document.getElementById("start-btn").onclick = startGame;
document.getElementById("feed").onclick = actFeed;
document.getElementById("play").onclick = actPlay;
document.getElementById("clean").onclick = actClean;
document.getElementById("nap").onclick = actNap;
document.getElementById("med").onclick = actMed;

/* Load previous cat + history */
load();
applyTimeDecay();

if (history.length > 0) {
  document.getElementById("log").innerHTML = history.join("<br>");
}

render();
</script>

</body>
</html>
