<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tama‑Cat v5.2</title>
<style>
  body {
    background: #050608;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: monospace;
    color: #eee;
  }

  .device {
    background: #222;
    border: 8px solid #666;
    border-radius: 30px;
    padding: 16px;
    width: 420px;
    box-shadow: 0 0 25px #000 inset, 0 0 14px #000;
  }

  #name-box {
    margin-bottom: 6px;
    font-size: 11px;
  }

  input, select {
    background: #111;
    border: 1px solid #444;
    color: #eee;
    padding: 2px 4px;
    font-size: 11px;
  }

  #name-input { width: 120px; }
  #personality-select { width: 90px; }

  .screen {
    background: #c8f7c8;
    color: #000;
    border: 4px solid #333;
    border-radius: 4px;
    padding: 4px;
    height: 190px;
    box-shadow: 0 0 8px #000 inset;
    display: flex;
    flex-direction: column;
  }

  .screen-top {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .screen-top pre {
    margin: 0;
    font-size: 12px;
    line-height: 12px;
  }

  .screen-bottom {
    height: 50px;
    font-size: 11px;
    line-height: 12px;
    padding-top: 2px;
    white-space: normal;
    overflow: hidden;
  }

  .stats-row {
    display: flex;
    flex-direction: row;
    margin-top: 6px;
  }

  .stats {
    font-size: 11px;
    white-space: pre;
    width: 50%;
  }

  .play-menu {
    font-size: 11px;
    white-space: pre;
    width: 50%;
    padding-left: 6px;
  }

  .play-menu-box {
    border: 1px solid #777;
    padding: 4px;
  }

  .play-menu-title {
    font-weight: bold;
    font-size: 11px;
    margin-bottom: 2px;
  }

  .play-menu-option {
    display: block;
    width: 100%;
    text-align: left;
    background: #333;
    border: 1px solid #666;
    border-radius: 3px;
    color: #eee;
    font-size: 10px;
    padding: 2px 4px;
    margin-top: 2px;
    cursor: pointer;
  }

  .play-menu-option.highlighted {
    background: #555;
    border-color: #aaa;
  }

  .play-menu-close {
    display: block;
    width: 100%;
    text-align: center;
    background: #444;
    border: 1px solid #777;
    border-radius: 3px;
    color: #eee;
    font-size: 10px;
    padding: 2px 4px;
    margin-top: 4px;
    cursor: pointer;
  }

  .play-menu-option:hover,
  .play-menu-close:hover {
    background: #666;
  }

  .buttons {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  button {
    flex: 1 1 30%;
    min-width: 70px;
    height: 26px;
    background: #444;
    border: 2px solid #777;
    border-radius: 6px;
    color: #eee;
    font-size: 10px;
    cursor: pointer;
  }

  button:hover {
    background: #555;
  }

  button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  #log {
    margin-top: 6px;
    font-size: 10px;
    height: 60px;
    overflow-y: auto;
    white-space: normal;
  }
</style>
</head>
<body>

<div class="device">
  <div id="name-box">
    Name:
    <input id="name-input" placeholder="Mochi">
    Personality:
    <select id="personality-select">
      <option value="balanced">Balanced</option>
      <option value="lazy">Lazy</option>
      <option value="playful">Playful</option>
      <option value="grumpy">Grumpy</option>
      <option value="needy">Needy</option>
    </select>
    <button id="start-btn">Start</button>
  </div>

  <div class="screen">
    <div class="screen-top" id="screen-top"></div>
    <div class="screen-bottom" id="screen-bottom"></div>
  </div>

  <div class="stats-row">
    <div class="stats" id="stats"></div>
    <div class="play-menu" id="play-menu"></div>
  </div>

  <div class="buttons">
    <button id="feed">Feed</button>
    <button id="play">Play</button>
    <button id="clean">Clean</button>
    <button id="nap">Nap</button>
    <button id="med">Med</button>
  </div>

  <div id="log"></div>
</div>

<script>
/* ---------------- ASCII ART ---------------- */
const art = {
  // KITTEN
  kitten_idle: ` /\\_/\\
( o.o )
 > ^ <`,
  kitten_happy: ` /\\_/\\
( ^.^ )
 > ^ <`,
  kitten_hungry: ` /\\_/\\
( ;.; )
 > ^ <`,
  kitten_sleepy: ` /\\_/\\
(-.- ) zZ
 > ^ <`,
  kitten_angry: ` /\\_/\\
( >.< )
 > ^ <`,
  kitten_dirty: ` /\\_/\\
( o.o ) ~
 > ^ <`,
  kitten_full: ` /\\_/\\
( -w- )
 > ^ <`,
  kitten_sick: ` /\\_/\\
( x.x )
 > ^ <`,
  kitten_lonely: ` /\\_/\\
( ; _ ; )
 > ^ <`,
  kitten_excited: ` /\\_/\\
( ^o^ )
 > ^ <`,
  kitten_mischief: ` /\\_/\\
( ^_^ )
 > v <`,
  kitten_dead: ` /\\_/\\
(x_x )
 > ^ <`,

  // ADULT
  adult_idle: ` /\\___/\\
( 0   0 )
 (  =^=  )`,
  adult_happy: ` /\\___/\\
( ^   ^ )
 (  =^=  )`,
  adult_hungry: ` /\\___/\\
( ;   ; )
 (  =^=  )`,
  adult_sleepy: ` /\\___/\\
( -   - ) zZ
 (  =^=  )`,
  adult_angry: ` /\\___/\\
( >   < )
 (  =^=  )`,
  adult_dirty: ` /\\___/\\
( 0   0 ) ~
 (  =^=  )`,
  adult_full: ` /\\___/\\
( -   w )
 (  =^=  )`,
  adult_sick: ` /\\___/\\
( x   x )
 (  =^=  )`,
  adult_lonely: ` /\\___/\\
( ;   _ )
 (  =^=  )`,
  adult_excited: ` /\\___/\\
( ^   o )
 (  =^=  )`,
  adult_mischief: ` /\\___/\\
( ^   ^ )
 (  =v=  )`,
  adult_dead: ` /\\___/\\
( x   x )
 (  =^=  )`,

  // ELDER
  elder_idle: ` /\\___/\\
( -   - )
 (  =w=  )`,
  elder_happy: ` /\\___/\\
( ^   ^ )
 (  =w=  )`,
  elder_hungry: ` /\\___/\\
( ;   ; )
 (  =w=  )`,
  elder_sleepy: ` /\\___/\\
( -   - ) zZ
 (  =w=  )`,
  elder_angry: ` /\\___/\\
( >   < )
 (  =w=  )`,
  elder_dirty: ` /\\___/\\
( -   - ) ~
 (  =w=  )`,
  elder_full: ` /\\___/\\
( -   w )
 (  =w=  )`,
  elder_sick: ` /\\___/\\
( x   x )
 (  =w=  )`,
  elder_lonely: ` /\\___/\\
( ;   _ )
 (  =w=  )`,
  elder_excited: ` /\\___/\\
( ^   o )
 (  =w=  )`,
  elder_mischief: ` /\\___/\\
( ^   ^ )
 (  =v=  )`,
  elder_dead: ` /\\___/\\
( x   x )
 (  =w=  )`
};

/* ---------------- DIALOGUE ---------------- */
const dialog = {
  kitten: {
    idle: [
      "The tiny kitten blinks at you.",
      "It paws at the screen."
    ],
    happy: [
      "The kitten hops with joy.",
      "Tiny purrs buzz softly."
    ],
    hungry: [
      "The kitten squeaks for food.",
      "It noses an imaginary bowl."
    ],
    sleepy: [
      "Its head droops slowly.",
      "It fights sleep and loses."
    ],
    angry: [
      "A tiny hiss escapes.",
      "It bats at you angrily."
    ],
    dirty: [
      "Its fur is a static mess.",
      "It looks dusty and chaotic."
    ],
    full: [
      "The kitten flops over.",
      "It chirps contentedly."
    ],
    sick: [
      "The kitten looks woozy.",
      "Its ears droop sadly."
    ],
    lonely: [
      "The kitten stares at you.",
      "It curls up quietly."
    ],
    excited: [
      "Zoomies erupt everywhere.",
      "It darts around wildly."
    ],
    mischief: [
      "It plots nonsense.",
      "Its eyes glint with chaos."
    ]
  },
  adult: {
    idle: [
      "Your cat lounges calmly.",
      "It flicks its tail slowly."
    ],
    happy: [
      "A deep purr fills the air.",
      "It bumps the screen gently."
    ],
    hungry: [
      "The stare intensifies.",
      "You feel judged."
    ],
    sleepy: [
      "A slow blink forms.",
      "It kneads an invisible blanket."
    ],
    angry: [
      "Its tail flicks sharply.",
      "It looks unimpressed."
    ],
    dirty: [
      "It grooms aggressively.",
      "Dust has offended it."
    ],
    full: [
      "It stretches luxuriously.",
      "A soft burp escapes."
    ],
    sick: [
      "Your cat looks dull.",
      "It rests quietly."
    ],
    lonely: [
      "It waits for you.",
      "The slow blink lingers."
    ],
    excited: [
      "Sudden zoomies appear.",
      "It pounces at nothing."
    ],
    mischief: [
      "Trouble is brewing.",
      "Something would be knocked over."
    ]
  },
  elder: {
    idle: [
      "The old cat rests calmly.",
      "It watches with wisdom."
    ],
    happy: [
      "A low purr rumbles.",
      "It leans in gently."
    ],
    hungry: [
      "A polite stare forms.",
      "It meows once softly."
    ],
    sleepy: [
      "Its eyes close slowly.",
      "It tucks its paws neatly."
    ],
    angry: [
      "It narrows its eyes.",
      "Judgment intensifies."
    ],
    dirty: [
      "It grooms slowly.",
      "It sighs quietly."
    ],
    full: [
      "It settles in warmly.",
      "A satisfied sigh escapes."
    ],
    sick: [
      "The old cat looks fragile.",
      "You feel worried."
    ],
    lonely: [
      "It gazes toward you.",
      "Its slow blink requests company."
    ],
    excited: [
      "A spark of energy appears.",
      "It plays in small motions."
    ],
    mischief: [
      "A tiny spark returns.",
      "You see its younger self."
    ]
  }
};

/* ---------------- CAT STATE ---------------- */
let cat = {
  name: "Mochi",
  personality: "balanced",
  hunger: 50,
  energy: 50,
  happiness: 50,
  cleanliness: 50,
  sick: false,
  alive: false,
  lastCheck: Date.now(),
  isNapping: false,
  napStart: null,
  birth: Date.now(),
  ageDays: 0,
  stage: "kitten",
  lastBirthdayNotified: -1
};

let history = [];
const DECAY_CHUNK_MINUTES = 10;

/* ---------------- MINI-GAME STATE ---------------- */
let game = {
  active: false,
  score: 0,
  endTime: 0,
  timerId: null
};

let dotGame = {
  active: false,
  position: 1, // 0 = left, 1 = center, 2 = right
  timerId: null,
  score: 0,
  endTime: 0
};

/* ---------------- PLAY MENU STATE ---------------- */
let playMenu = false;
let playMenuIndex = 0;
let playMenuTimer = null;

/* ---------------- UTIL ---------------- */
function save() {
  localStorage.setItem("tamaCat_v5_2", JSON.stringify(cat));
  localStorage.setItem("tamaCat_v5_2_history", JSON.stringify(history));
}

function load() {
  const data = localStorage.getItem("tamaCat_v5_2");
  const hist = localStorage.getItem("tamaCat_v5_2_history");
  if (data) cat = JSON.parse(data);
  if (hist) history = JSON.parse(hist);
}

function logMsg(msg) {
  const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const entry = `[${timestamp}] ${msg}`;
  history.unshift(entry);
  if (history.length > 300) history.pop();
  document.getElementById("log").innerHTML = history.join("<br>");
  save();
}

function beep(freq = 800, duration = 120) {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "square";
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
    osc.stop(ctx.currentTime + duration / 1000);
  } catch (e) {}
}

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* ---------------- AGE & STAGE ---------------- */
function updateAge() {
  const now = Date.now();
  const days = Math.floor((now - cat.birth) / (1000 * 60 * 60 * 24));
  const oldDays = cat.ageDays;

  cat.ageDays = days;

  if (days < 3) cat.stage = "kitten";
  else if (days < 10) cat.stage = "adult";
  else cat.stage = "elder";

  if (days > 0 && days !== cat.lastBirthdayNotified) {
    if (days !== oldDays) {
      cat.happiness = Math.min(100, cat.happiness + 10);
      logMsg("It's " + cat.name + "'s day " + days + "! Happy birthday!");
      beep(1200, 180);
      cat.lastBirthdayNotified = days;
    }
  }
}

/* ---------------- MOOD & ART ---------------- */
function getMoodAndArt() {
  if (!cat.alive) {
    return { art: art[`${cat.stage}_dead`] || art.kitten_dead, mood: "dead" };
  }
  if (cat.isNapping) {
    return { art: art[`${cat.stage}_sleepy`] || art.kitten_sleepy, mood: "sleepy" };
  }
  if (cat.sick) {
    return { art: art[`${cat.stage}_sick`] || art.kitten_sick, mood: "sick" };
  }

  if (cat.happiness < 20) {
    return { art: art[`${cat.stage}_lonely`] || art.kitten_lonely, mood: "lonely" };
  }
  if (cat.hunger < 20) {
    return { art: art[`${cat.stage}_hungry`] || art.kitten_hungry, mood: "hungry" };
  }
  if (cat.cleanliness < 20) {
    return { art: art[`${cat.stage}_dirty`] || art.kitten_dirty, mood: "dirty" };
  }
  if (cat.energy < 20) {
    return { art: art[`${cat.stage}_sleepy`] || art.kitten_sleepy, mood: "sleepy" };
  }
  if (cat.hunger > 85) {
    return { art: art[`${cat.stage}_full`] || art.kitten_full, mood: "full" };
  }
  if (cat.happiness > 80) {
    return { art: art[`${cat.stage}_happy`] || art.kitten_happy, mood: "happy" };
  }

  if (cat.happiness >= 50 && cat.energy >= 40) {
    const r = Math.random();
    if (r < 0.15) {
      return { art: art[`${cat.stage}_excited`] || art.kitten_excited, mood: "excited" };
    }
    if (r < 0.30) {
      return { art: art[`${cat.stage}_mischief`] || art.kitten_mischief, mood: "mischief" };
    }
  }

  return { art: art[`${cat.stage}_idle`] || art.kitten_idle, mood: "idle" };
}

/* ---------------- CLAMP & HEALTH ---------------- */
function clamp() {
  ["hunger","energy","happiness","cleanliness"].forEach(k => {
    cat[k] = Math.max(0, Math.min(100, cat[k]));
  });
}

function checkAlive() {
  if (cat.hunger <= 0 || cat.energy <= 0 || cat.happiness <= 0) {
    if (cat.alive) {
      logMsg(cat.name + " has passed away...");
      beep(200, 400);
    }
    cat.alive = false;
    cat.isNapping = false;
    cat.napStart = null;
    if (game.active) {
      clearInterval(game.timerId);
      game.active = false;
    }
    if (dotGame.active) {
      clearInterval(dotGame.timerId);
      dotGame.active = false;
    }
  }
}

function sicknessCheck() {
  if (cat.hunger > 95 || cat.cleanliness < 10 || cat.energy < 5) {
    if (!cat.sick) {
      cat.sick = true;
      logMsg(cat.name + " has become sick.");
      beep(400, 200);
    }
  }
}

/* ---------------- TIME DECAY ---------------- */
function applyTimeDecay() {
  const now = Date.now();
  const diffMinutes = Math.floor((now - cat.lastCheck) / (1000 * 60));
  if (diffMinutes <= 0) {
    updateAge();
    return;
  }

  let chunks = Math.floor(diffMinutes / DECAY_CHUNK_MINUTES);
  if (chunks < 1) chunks = 1;

  if (!cat.isNapping && cat.alive) {
    cat.hunger -= 4 * chunks;
    cat.energy -= 3 * chunks;
    cat.cleanliness -= 3 * chunks;
    cat.happiness -= 3 * chunks;
  }

  if (cat.isNapping && cat.napStart && cat.alive) {
    const napMinutes = Math.floor((now - cat.napStart) / (1000 * 60));
    if (napMinutes > 0) {
      const energyGain = napMinutes * 5;
      const hungerDrain = napMinutes * 1;
      const cleanDrain  = napMinutes * 2;

      cat.energy += energyGain;
      cat.hunger -= hungerDrain;
      cat.cleanliness -= cleanDrain;

      cat.napStart = now;

      logMsg(
        `${cat.name} slept for ${napMinutes} min: +${energyGain} energy, -${hungerDrain} hunger, -${cleanDrain} cleanliness.`
      );

      if (cat.energy >= 100) {
        cat.energy = 100;
        cat.isNapping = false;
        logMsg(cat.name + " wakes up fully rested.");
        beep(900, 120);
      }
    }
  }

  cat.lastCheck = now;
  clamp();
  sicknessCheck();
  checkAlive();
  updateAge();
}

/* ---------------- PERSONALITY MODIFIERS ---------------- */
function applyPersonalityModifiers(action, deltas) {
  const p = cat.personality;
  const result = {...deltas};

  if (p === "lazy") {
    if (action === "nap") result.energy = Math.round(result.energy * 1.3);
    if (action === "play") result.energy = Math.round(result.energy * 1.2);
  }

  if (p === "playful") {
    if (action === "play") result.happiness = Math.round(result.happiness * 1.4);
  }

  if (p === "grumpy") {
    if (action === "clean") result.happiness = Math.round(result.happiness * -1.4);
    if (action === "feed") result.happiness = Math.round(result.happiness * 0.7);
  }

  if (p === "needy") {
    if (action === "play" || action === "feed" || action === "clean") {
      result.happiness = Math.round(result.happiness * 1.2);
    }
  }

  return result;
}

/* ---------------- PLAY MENU ---------------- */
function cancelPlayMenu() {
  playMenu = false;
  playMenuIndex = 0;
  if (playMenuTimer) {
    clearTimeout(playMenuTimer);
    playMenuTimer = null;
  }
  const playMenuDiv = document.getElementById("play-menu");
  playMenuDiv.innerHTML = "";
}

function showPlayMenu() {
  const playMenuDiv = document.getElementById("play-menu");
  playMenuDiv.innerHTML = "";

  const box = document.createElement("div");
  box.className = "play-menu-box";

  const title = document.createElement("div");
  title.className = "play-menu-title";
  title.textContent = "Play Menu:";
  box.appendChild(title);

  const options = [
    { label: "Quick Play", handler: actPlayQuick },
    { label: "Mash Game", handler: startMiniGame },
    { label: "Catch-the-Dot", handler: startDotGame }
  ];

  options.forEach((opt, index) => {
    const btn = document.createElement("button");
    btn.className = "play-menu-option";
    if (index === playMenuIndex) {
      btn.classList.add("highlighted");
    }
    btn.textContent = opt.label;
    btn.onclick = () => {
      // If user clicks directly, cancel pending auto-start and run immediately
      if (playMenuTimer) {
        clearTimeout(playMenuTimer);
        playMenuTimer = null;
      }
      cancelPlayMenu();
      opt.handler();
    };
    box.appendChild(btn);
  });

  const closeBtn = document.createElement("button");
  closeBtn.className = "play-menu-close";
  closeBtn.textContent = "Close";
  closeBtn.onclick = () => {
    if (playMenuTimer) {
      clearTimeout(playMenuTimer);
      playMenuTimer = null;
    }
    cancelPlayMenu();
    render();
  };
  box.appendChild(closeBtn);

  playMenuDiv.appendChild(box);
}

function startSelectedPlayOption() {
  if (!playMenu) return;

  const index = playMenuIndex;
  if (playMenuTimer) {
    clearTimeout(playMenuTimer);
    playMenuTimer = null;
  }
  cancelPlayMenu();

  if (index === 0) {
    actPlayQuick();
  } else if (index === 1) {
    startMiniGame();
  } else {
    startDotGame();
  }
}

function handlePlayButton() {
  if (!cat.alive || cat.isNapping) return;

  // If mash mini-game is active, PLAY is the mash button
  if (game.active) {
    game.score += 1;
    beep(1100, 60);
    render();
    return;
  }

  // If dot game is active, PLAY is the catch button
  if (dotGame.active) {
    if (dotGame.position === 1) {
      dotGame.score++;
      beep(1300, 80);
    } else {
      beep(500, 60);
    }
    return;
  }

  // If menu is not open, open it
  if (!playMenu) {
    playMenu = true;
    playMenuIndex = 0;
    showPlayMenu();

    if (playMenuTimer) clearTimeout(playMenuTimer);
    playMenuTimer = setTimeout(startSelectedPlayOption, 1000);
    return;
  }

  // Menu is open → cycle highlighted option
  playMenuIndex = (playMenuIndex + 1) % 3;
  showPlayMenu();

  if (playMenuTimer) clearTimeout(playMenuTimer);
  playMenuTimer = setTimeout(startSelectedPlayOption, 1000);
}

/* ---------------- ACTIONS ---------------- */
function actFeed() {
  if (!cat.alive || game.active || dotGame.active) return;
  cancelPlayMenu();

  let deltas = { hunger: +18, energy: 0, happiness: +4, cleanliness: 0 };
  deltas = applyPersonalityModifiers("feed", deltas);

  cat.hunger += deltas.hunger;
  cat.energy += deltas.energy;
  cat.happiness += deltas.happiness;

  clamp();
  logMsg("You feed " + cat.name + ". Tiny crunches echo in the void.");
  beep(900, 80);
  sicknessCheck();
  tick();
}

function actPlayQuick() {
  if (!cat.alive || game.active || dotGame.active) return;

  let deltas = { hunger: -5, energy: -12, happiness: +15, cleanliness: 0 };
  deltas = applyPersonalityModifiers("play", deltas);

  cat.hunger += deltas.hunger;
  cat.energy += deltas.energy;
  cat.happiness += deltas.happiness;

  clamp();
  logMsg(cat.name + " goes wild with zoomies.");
  beep(1000, 80);
  sicknessCheck();
  tick();
}

function actClean() {
  if (!cat.alive || game.active || dotGame.active) return;
  cancelPlayMenu();

  let deltas = { hunger: 0, energy: 0, happiness: -4, cleanliness: +25 };
  deltas = applyPersonalityModifiers("clean", deltas);

  cat.hunger += deltas.hunger;
  cat.energy += deltas.energy;
  cat.happiness += deltas.happiness;
  cat.cleanliness += deltas.cleanliness;

  clamp();
  logMsg("You clean " + cat.name + ". It looks better, but clearly resents it.");
  beep(850, 80);
  sicknessCheck();
  tick();
}

function actNap() {
  if (!cat.alive || game.active || dotGame.active) return;
  cancelPlayMenu();

  if (cat.isNapping) {
    cat.isNapping = false;
    cat.napStart = null;
    logMsg(cat.name + " wakes up early from the nap.");
    beep(950, 120);
    clamp();
    sicknessCheck();
    tick();
    return;
  }

  cat.isNapping = true;
  cat.napStart = Date.now();

  let deltas = { hunger: -3, energy: 0, happiness: +3, cleanliness: 0 };
  deltas = applyPersonalityModifiers("nap", deltas);

  cat.hunger += deltas.hunger;
  cat.happiness += deltas.happiness;

  clamp();
  sicknessCheck();
  logMsg(cat.name + " curls up and begins a long nap.");
  beep(700, 80);
  tick();
}

function actMed() {
  if (!cat.alive || game.active || dotGame.active) return;
  cancelPlayMenu();

  if (!cat.sick) {
    logMsg(cat.name + " doesn't need medicine right now.");
    return;
  }

  cat.sick = false;
  cat.happiness = Math.min(100, cat.happiness + 10);
  logMsg("You give " + cat.name + " medicine. It looks better already.");
  beep(1100, 120);
  tick();
}

/* ---------------- MINI-GAME: MASH GAME ---------------- */
function startMiniGame() {
  if (!cat.alive || game.active || dotGame.active || cat.isNapping) return;

  game.active = true;
  game.score = 0;
  game.endTime = Date.now() + 10000; // 10 seconds

  logMsg("Mini-game started! Mash PLAY to cheer up " + cat.name + "!");
  beep(1200, 100);

  if (game.timerId) clearInterval(game.timerId);
  game.timerId = setInterval(() => {
    if (!game.active) {
      clearInterval(game.timerId);
      return;
    }
    if (Date.now() >= game.endTime) {
      endMiniGame();
    } else {
      render();
    }
  }, 150);

  render();
}

function endMiniGame() {
  if (!game.active) return;
  game.active = false;
  clearInterval(game.timerId);

  const rewardHappiness = Math.min(30, game.score * 2);
  const costEnergy = Math.min(20, Math.floor(game.score / 2));

  cat.happiness = Math.min(100, cat.happiness + rewardHappiness);
  cat.energy = Math.max(0, cat.energy - costEnergy);

  clamp();
  logMsg(
    `Mini-game over! Score: ${game.score}. Happiness +${rewardHappiness}, Energy -${costEnergy}.`
  );
  beep(900, 140);
  sicknessCheck();
  tick();
}

/* ---------------- MINI-GAME: CATCH-THE-DOT ---------------- */
function startDotGame() {
  if (!cat.alive || dotGame.active || game.active || cat.isNapping) return;

  dotGame.active = true;
  dotGame.score = 0;
  dotGame.position = 1;
  dotGame.endTime = Date.now() + 10000; // 10 seconds

  logMsg("Catch-the-Dot started! Tap PLAY when the dot is in the center!");
  beep(1200, 100);

  if (dotGame.timerId) clearInterval(dotGame.timerId);
  dotGame.timerId = setInterval(() => {
    if (!dotGame.active) return;

    dotGame.position = (dotGame.position + 1) % 3;

    if (Date.now() >= dotGame.endTime) {
      endDotGame();
    } else {
      render();
    }
  }, 300);

  render();
}

function endDotGame() {
  if (!dotGame.active) return;
  dotGame.active = false;
  clearInterval(dotGame.timerId);

  const reward = Math.min(25, dotGame.score * 3);
  const cost = Math.min(15, Math.floor(dotGame.score / 2));

  cat.happiness = Math.min(100, cat.happiness + reward);
  cat.energy = Math.max(0, cat.energy - cost);

  clamp();
  logMsg(`Dot Game over! Score: ${dotGame.score}. Happiness +${reward}, Energy -${cost}.`);
  beep(900, 140);
  sicknessCheck();
  tick();
}

/* ---------------- RENDER ---------------- */
function render() {
  const screenTop = document.getElementById("screen-top");
  const screenBottom = document.getElementById("screen-bottom");
  const stats = document.getElementById("stats");

  const { art: artState, mood } = getMoodAndArt();
  screenTop.innerHTML = "<pre>" + artState + "</pre>";

  if (dotGame.active) {
    const pos = dotGame.position;
    const display = [" ", " ", " "];
    display[pos] = "●";

    screenBottom.textContent =
      "Catch-the-Dot!\n" +
      `[${display[0]}] [${display[1]}] [${display[2]}]\n` +
      `Score: ${dotGame.score}`;
  } else if (game.active) {
    const secondsLeft = Math.max(0, Math.ceil((game.endTime - Date.now()) / 1000));
    screenBottom.textContent =
      "Mini-game: Mash PLAY!\n" +
      "Score: " + game.score + "   Time: " + secondsLeft + "s";
  } else if (!cat.alive) {
    screenBottom.textContent = cat.name + " is gone...";
  } else if (cat.isNapping) {
    screenBottom.textContent = cat.name + " is napping peacefully...";
  } else {
    const stageDialog = dialog[cat.stage] || dialog.kitten;
    const lines = stageDialog[mood] || stageDialog.idle || dialog.kitten.idle;
    screenBottom.textContent = randomChoice(lines);
  }

  stats.textContent =
    `Hunger:      ${cat.hunger}
Energy:      ${cat.energy}
Happiness:   ${cat.happiness}
Cleanliness: ${cat.cleanliness}
Sick:        ${cat.sick ? "YES" : "NO"}
Age:         ${cat.ageDays} days
Stage:       ${cat.stage}
Personality: ${cat.personality}`;

  const actionsDisabled = cat.isNapping || !cat.alive || game.active || dotGame.active;
  document.getElementById("feed").disabled = actionsDisabled;
  document.getElementById("clean").disabled = actionsDisabled;
  document.getElementById("med").disabled = actionsDisabled;
  document.getElementById("nap").disabled = !cat.alive || game.active || dotGame.active;
  document.getElementById("play").disabled = !cat.alive;
  document.getElementById("nap").textContent = cat.isNapping ? "Wake" : "Nap";
}

/* ---------------- TICK & INIT ---------------- */
function tick() {
  cat.lastCheck = Date.now();
  clamp();
  checkAlive();
  updateAge();
  save();
  render();
}

function startGame() {
  cancelPlayMenu();
  cat.name = document.getElementById("name-input").value.trim() || "Mochi";
  cat.personality = document.getElementById("personality-select").value;
  cat.hunger = 50;
  cat.energy = 50;
  cat.happiness = 50;
  cat.cleanliness = 50;
  cat.sick = false;
  cat.alive = true;
  cat.isNapping = false;
  cat.napStart = null;
  cat.birth = Date.now();
  cat.ageDays = 0;
  cat.stage = "kitten";
  cat.lastBirthdayNotified = -1;
  cat.lastCheck = Date.now();

  if (game.timerId) clearInterval(game.timerId);
  game.active = false;
  game.score = 0;

  if (dotGame.timerId) clearInterval(dotGame.timerId);
  dotGame.active = false;
  dotGame.score = 0;

  save();
  render();
  logMsg(cat.name + " wakes up in the tiny screen.");
  beep(1000, 100);
}

/* ---------------- BUTTONS ---------------- */
document.getElementById("start-btn").onclick = startGame;
document.getElementById("feed").onclick = actFeed;
document.getElementById("play").onclick = handlePlayButton;
document.getElementById("clean").onclick = actClean;
document.getElementById("nap").onclick = actNap;
document.getElementById("med").onclick = actMed;

/* ---------------- LOAD & START ---------------- */
load();
applyTimeDecay();

if (history.length > 0) {
  document.getElementById("log").innerHTML = history.join("<br>");
}

render();
</script>

</body>
</html>
