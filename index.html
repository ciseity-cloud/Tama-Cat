<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tamaâ€‘Cat v5.1</title>
<style>
  body {
    background: #050608;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: monospace;
    color: #eee;
  }

  .device {
    background: #222;
    border: 8px solid #666;
    border-radius: 30px;
    padding: 16px;
    width: 360px;
    box-shadow: 0 0 25px #000 inset, 0 0 14px #000;
  }

  #name-box {
    margin-bottom: 6px;
    font-size: 11px;
  }

  input, select {
    background: #111;
    border: 1px solid #444;
    color: #eee;
    padding: 2px 4px;
    font-size: 11px;
  }

  #name-input { width: 120px; }
  #personality-select { width: 90px; }

  .screen {
    background: #c8f7c8;
    color: #000;
    border: 4px solid #333;
    border-radius: 4px;
    padding: 4px;
    height: 190px;
    box-shadow: 0 0 8px #000 inset;
    display: flex;
    flex-direction: column;
  }

  .screen-top {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .screen-top pre {
    margin: 0;
    font-size: 11px;
    line-height: 11px;
  }

  .screen-bottom {
    height: 50px;
    font-size: 11px;
    line-height: 12px;
    padding-top: 2px;
    white-space: normal;
    overflow: hidden;
  }

  .stats {
    font-size: 11px;
    margin-top: 6px;
    white-space: pre;
  }

  .buttons {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  button {
    flex: 1 1 30%;
    min-width: 70px;
    height: 26px;
    background: #444;
    border: 2px solid #777;
    border-radius: 6px;
    color: #eee;
    font-size: 10px;
    cursor: pointer;
  }

  button:hover {
    background: #555;
  }

  button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  #log {
    margin-top: 6px;
    font-size: 10px;
    height: 60px;
    overflow-y: auto;
    white-space: normal;
  }
</style>
</head>
<body>

<div class="device">
  <div id="name-box">
    Name:
    <input id="name-input" placeholder="Mochi">
    Personality:
    <select id="personality-select">
      <option value="balanced">Balanced</option>
      <option value="lazy">Lazy</option>
      <option value="playful">Playful</option>
      <option value="grumpy">Grumpy</option>
      <option value="needy">Needy</option>
    </select>
    <button id="start-btn">Start</button>
  </div>

  <div class="screen">
    <div class="screen-top" id="screen-top"></div>
    <div class="screen-bottom" id="screen-bottom"></div>
  </div>

  <div class="stats" id="stats"></div>

  <div class="buttons">
    <button id="feed">Feed</button>
    <button id="play">Play</button>
    <button id="clean">Clean</button>
    <button id="nap">Nap</button>
    <button id="med">Med</button>
    <button id="game">Game</button>
    <button id="env">Env</button>
  </div>

  <div id="log"></div>
</div>

<script>
/* ---------------- ASCII CAT ART ---------------- */
// Each key is `${stage}_${mood}`
const art = {
  // KITTEN
  kitten_idle: ` /\\_/\\
( o.o )
 > ^ <`,
  kitten_happy: ` /\\_/\\
( ^.^ )
 > ^ <`,
  kitten_hungry: ` /\\_/\\
( ;.; )
 > ^ <`,
  kitten_sleepy: ` /\\_/\\
(-.- ) zZ
 > ^ <`,
  kitten_angry: ` /\\_/\\
( >.< )
 > ^ <`,
  kitten_dirty: ` /\\_/\\
( o.o ) ~
 > ^ <`,
  kitten_full: ` /\\_/\\
( -w- )
 > ^ <`,
  kitten_sick: ` /\\_/\\
( x.x )
 > ^ <`,
  kitten_lonely: ` /\\_/\\
( ; _ ; )
 > ^ <`,
  kitten_excited: ` /\\_/\\
( ^o^ )
 > ^ <`,
  kitten_mischief: ` /\\_/\\
( ^_^ )
 > v <`,
  kitten_dead: ` /\\_/\\
(x_x )
 > ^ <`,

  // ADULT
  adult_idle: ` /\\___/\\
( 0   0 )
 (  =^=  )`,
  adult_happy: ` /\\___/\\
( ^   ^ )
 (  =^=  )`,
  adult_hungry: ` /\\___/\\
( ;   ; )
 (  =^=  )`,
  adult_sleepy: ` /\\___/\\
( -   - ) zZ
 (  =^=  )`,
  adult_angry: ` /\\___/\\
( >   < )
 (  =^=  )`,
  adult_dirty: ` /\\___/\\
( 0   0 ) ~
 (  =^=  )`,
  adult_full: ` /\\___/\\
( -   w )
 (  =^=  )`,
  adult_sick: ` /\\___/\\
( x   x )
 (  =^=  )`,
  adult_lonely: ` /\\___/\\
( ;   _ )
 (  =^=  )`,
  adult_excited: ` /\\___/\\
( ^   o )
 (  =^=  )`,
  adult_mischief: ` /\\___/\\
( ^   ^ )
 (  =v=  )`,
  adult_dead: ` /\\___/\\
( x   x )
 (  =^=  )`,

  // ELDER
  elder_idle: ` /\\___/\\
( -   - )
 (  =w=  )`,
  elder_happy: ` /\\___/\\
( ^   ^ )
 (  =w=  )`,
  elder_hungry: ` /\\___/\\
( ;   ; )
 (  =w=  )`,
  elder_sleepy: ` /\\___/\\
( -   - ) zZ
 (  =w=  )`,
  elder_angry: ` /\\___/\\
( >   < )
 (  =w=  )`,
  elder_dirty: ` /\\___/\\
( -   - ) ~
 (  =w=  )`,
  elder_full: ` /\\___/\\
( -   w )
 (  =w=  )`,
  elder_sick: ` /\\___/\\
( x   x )
 (  =w=  )`,
  elder_lonely: ` /\\___/\\
( ;   _ )
 (  =w=  )`,
  elder_excited: ` /\\___/\\
( ^   o )
 (  =w=  )`,
  elder_mischief: ` /\\___/\\
( ^   ^ )
 (  =v=  )`,
  elder_dead: ` /\\___/\\
( x   x )
 (  =w=  )`
};

/* ---------------- SURROUNDINGS / ENVIRONMENTS ---------------- */
// Wrapper functions: surroundings[env](catArt) -> big ASCII block
const surroundings = {
  floor: (catArt) => {
    const lines = catArt.split("\n").map(l => "   " + l);
    return `
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚               â”‚
${lines.map(l => "   â”‚" + l.padEnd(15, " ") + "â”‚").join("\n")}
   â”‚               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
        ( floor )
`.trim();
  },

  bed: (catArt) => {
    const lines = catArt.split("\n").map(l => "   " + l);
    return `
   â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
   â”‚   soft bed    â”‚
${lines.map(l => "   â”‚" + l.padEnd(15, " ") + "â”‚").join("\n")}
   â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        z  z  z
`.trim();
  },

  tower: (catArt) => {
    const lines = catArt.split("\n").map(l => "   " + l);
    return `
      ðŸ¾ Cat Tower ðŸ¾
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
${lines.map(l => "   â•‘" + l.padEnd(15, " ") + "â•‘").join("\n")}
   â•šâ•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•
           â•‘
        â•”â•â•â•©â•â•â•—
        â•‘ baseâ•‘
        â•šâ•â•â•â•â•â•
`.trim();
  },

  window: (catArt) => {
    const lines = catArt.split("\n").map(l => "   " + l);
    return `
   ðŸŒ¤ï¸  Window View  ðŸŒ¤ï¸
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
${lines.map(l => "  â”‚" + l.padEnd(17, " ") + "â”‚").join("\n")}
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      birds chirping
`.trim();
  },

  box: (catArt) => {
    const lines = catArt.split("\n").map(l => "   " + l);
    return `
      ðŸ“¦ Cardboard Box ðŸ“¦
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
${lines.map(l => "   â”‚" + l.padEnd(17, " ") + "â”‚").join("\n")}
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (cats love boxes)
`.trim();
  },

  blanket: (catArt) => {
    const lines = catArt.split("\n").map(l => "   " + l);
    return `
   ~~~~~~~~~~~~~~~~~~~~~
   ~   cozy blanket    ~
${lines.map(l => "   ~" + l.padEnd(17, " ") + "~").join("\n")}
   ~~~~~~~~~~~~~~~~~~~~~
`.trim();
  }
};

/* ---------------- STAGE-SPECIFIC DIALOGUE ---------------- */
const dialog = {
  kitten: {
    idle: [
      "The tiny kitten blinks at you, unsure but curious.",
      "It paws at the invisible screen edge."
    ],
    happy: [
      "The kitten does awkward little hops of joy.",
      "Tiny purrs buzz like a broken phone vibration."
    ],
    hungry: [
      "The kitten squeaks, clearly hoping food appears by magic.",
      "It noses an empty bowl that only exists in its mind."
    ],
    sleepy: [
      "Its head droops, then jerks back up. Repeat.",
      "The kitten fights sleep and is definitely losing."
    ],
    angry: [
      "A baby hiss. Adorable, not very threatening.",
      "It bats at you with a soft, offended paw."
    ],
    dirty: [
      "Its fur is a wild static mess.",
      "It looks like it rolled through imaginary crumbs."
    ],
    full: [
      "The kitten flops over, belly gloriously round.",
      "It makes a tiny satisfied chirp."
    ],
    sick: [
      "The kitten looks woozy and too quiet.",
      "Its ears droop; this isn't normal tired."
    ],
    lonely: [
      "The kitten stares at the screen, waiting.",
      "It curls into a ball, tail tucked for comfort."
    ],
    excited: [
      "Zoomies. Pure, chaotic zoomies.",
      "It darts around like the floor is lava."
    ],
    mischief: [
      "You can tell it's plotting some nonsense.",
      "Its eyes glint with tiny chaos."
    ]
  },
  adult: {
    idle: [
      "Your cat lounges with practiced elegance.",
      "It flicks its tail, perfectly content."
    ],
    happy: [
      "A deep, steady purr fills the imaginary room.",
      "It bumps its head against the fourth wall affectionately."
    ],
    hungry: [
      "The stare. The bowl. The stare again.",
      "You feel judged for not feeding it faster."
    ],
    sleepy: [
      "A slow blink, then another, then stillness.",
      "It kneads an invisible blanket before curling up."
    ],
    angry: [
      "The tail flick says: 'unacceptable.'",
      "Its ears angle back in dignified outrage."
    ],
    dirty: [
      "It grooms itself aggressively, clearly annoyed.",
      "A single speck of dust has personally offended it."
    ],
    full: [
      "It stretches luxuriously, very pleased with the snacks.",
      "A soft burp escapes. It pretends it didn't happen."
    ],
    sick: [
      "Your cat looks dull and slow, eyes half-lidded.",
      "No purring, just quiet discomfort."
    ],
    lonely: [
      "It waits at the edge of the screen for you.",
      "The slow blink feels just a little too long."
    ],
    excited: [
      "Sudden frantic zoom across the tiny world.",
      "It pounces on absolutely nothing with conviction."
    ],
    mischief: [
      "It has That Look. Trouble is brewing.",
      "You just know something would be knocked off a table."
    ]
  },
  elder: {
    idle: [
      "The old cat rests with wise calm.",
      "It watches you like it has seen everything."
    ],
    happy: [
      "A low, rumbling purr vibrates through time.",
      "It leans in, trusting and gentle."
    ],
    hungry: [
      "A polite but insistent stare meets you.",
      "It meows once, as if you should already know."
    ],
    sleepy: [
      "Its eyes close slowly, paws tucked neatly.",
      "This nap has been earned many times over."
    ],
    angry: [
      "It narrows its eyes, unimpressed by your choices.",
      "The tail tip twitches with ancient judgment."
    ],
    dirty: [
      "A speck of dust stands no chance under slow, careful grooming.",
      "It sighs as if it's done this a thousand times."
    ],
    full: [
      "It settles in with a satisfied sigh.",
      "Another meal successfully negotiated."
    ],
    sick: [
      "The old cat looks fragile and still.",
      "You feel a knot of worry in your chest."
    ],
    lonely: [
      "It gazes toward where you usually appear.",
      "Its slow blink carries a quiet request: stay a while."
    ],
    excited: [
      "Even elders get bursts of kitten energy.",
      "It plays in small, precise movements."
    ],
    mischief: [
      "A tiny spark of old mischief returns.",
      "You see a flicker of the kitten it once was."
    ]
  }
};

/* ---------------- CAT STATE ---------------- */
let cat = {
  name: "Mochi",
  personality: "balanced", // balanced, lazy, playful, grumpy, needy
  hunger: 50,
  energy: 50,
  happiness: 50,
  cleanliness: 50,
  sick: false,
  alive: false,
  lastCheck: Date.now(),
  isNapping: false,
  napStart: null,
  birth: Date.now(),
  ageDays: 0,
  stage: "kitten",           // kitten â†’ adult â†’ elder
  lastBirthdayNotified: -1,  // ageDays of last birthday message
  environment: "floor",      // floor, bed, tower, window, box, blanket
  environmentAuto: true      // true = auto-switch with stage, false = manual override
};

/* History + mini-game state */
let history = [];
const DECAY_CHUNK_MINUTES = 10;

let game = {
  active: false,
  score: 0,
  endTime: 0,
  timerId: null
};

/* ---------------- UTIL ---------------- */
function save() {
  localStorage.setItem("tamaCat_v5_1", JSON.stringify(cat));
  localStorage.setItem("tamaCat_v5_1_history", JSON.stringify(history));
}

function load() {
  const data = localStorage.getItem("tamaCat_v5_1");
  const hist = localStorage.getItem("tamaCat_v5_1_history");

  if (data) cat = JSON.parse(data);
  if (hist) history = JSON.parse(hist);
}

function logMsg(msg) {
  const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  const entry = `[${timestamp}] ${msg}`;
  history.unshift(entry);
  if (history.length > 300) history.pop();
  document.getElementById("log").innerHTML = history.join("<br>");
  save();
}

function beep(freq = 800, duration = 120) {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "square";
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
    osc.stop(ctx.currentTime + duration / 1000);
  } catch (e) {}
}

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* ---------------- ENVIRONMENT PREFERENCES ---------------- */
// Combine stage + personality to pick a preferred environment
function getPreferredEnvironment() {
  const st = cat.stage;
  const p = cat.personality;

  // Stage defaults
  let env = "floor";
  if (st === "kitten") env = "bed";
  else if (st === "adult") env = "tower";
  else if (st === "elder") env = "blanket";

  // Personality tweaks
  if (p === "lazy") env = "bed";
  if (p === "playful") env = "tower";
  if (p === "grumpy") env = "box";
  if (p === "needy") env = "blanket";
  if (p === "balanced" && st === "adult") env = "window";

  return env;
}

/* ---------------- AGE & STAGE ---------------- */
function updateAge() {
  const now = Date.now();
  const days = Math.floor((now - cat.birth) / (1000 * 60 * 60 * 24));
  const oldDays = cat.ageDays;
  const oldStage = cat.stage;

  cat.ageDays = days;

  // Stage thresholds
  if (days < 3) cat.stage = "kitten";
  else if (days < 10) cat.stage = "adult";
  else cat.stage = "elder";

  // If stage changed and environment is auto-managed, update it
  if (cat.stage !== oldStage && cat.environmentAuto) {
    cat.environment = getPreferredEnvironment();
    logMsg(cat.name + " settles into a new favorite spot as they grow: " + cat.environment + ".");
  }

  // Birthday events (every new day, starting from day 1)
  if (days > 0 && days !== cat.lastBirthdayNotified) {
    if (days !== oldDays) {
      cat.happiness = Math.min(100, cat.happiness + 10);
      logMsg("It's " + cat.name + "'s day " + days + " in this tiny world. Happy little birthday!");
      beep(1200, 180);
      cat.lastBirthdayNotified = days;
    }
  }
}

/* ---------------- MOOD & ART ---------------- */
function getMoodAndArt() {
  // Dead overrides everything
  if (!cat.alive) {
    return {
      art: art[`${cat.stage}_dead`] || art.kitten_dead,
      mood: "dead"
    };
  }

  // Napping override
  if (cat.isNapping) {
    return {
      art: art[`${cat.stage}_sleepy`] || art.kitten_sleepy,
      mood: "sleepy"
    };
  }

  // Sick override
  if (cat.sick) {
    return {
      art: art[`${cat.stage}_sick`] || art.kitten_sick,
      mood: "sick"
    };
  }

  // Mood priority
  if (cat.happiness < 20) {
    return {
      art: art[`${cat.stage}_lonely`] || art.kitten_lonely,
      mood: "lonely"
    };
  }

  if (cat.hunger < 20) {
    return {
      art: art[`${cat.stage}_hungry`] || art.kitten_hungry,
      mood: "hungry"
    };
  }

  if (cat.cleanliness < 20) {
    return {
      art: art[`${cat.stage}_dirty`] || art.kitten_dirty,
      mood: "dirty"
    };
  }

  if (cat.energy < 20) {
    return {
      art: art[`${cat.stage}_sleepy`] || art.kitten_sleepy,
      mood: "sleepy"
    };
  }

  if (cat.hunger > 85) {
    return {
      art: art[`${cat.stage}_full`] || art.kitten_full,
      mood: "full"
    };
  }

  if (cat.happiness > 80) {
    return {
      art: art[`${cat.stage}_happy`] || art.kitten_happy,
      mood: "happy"
    };
  }

  // Random fun moods
  if (cat.happiness >= 50 && cat.energy >= 40) {
    const r = Math.random();
    if (r < 0.15) {
      return {
        art: art[`${cat.stage}_excited`] || art.kitten_excited,
        mood: "excited"
      };
    }
    if (r < 0.30) {
      return {
        art: art[`${cat.stage}_mischief`] || art.kitten_mischief,
        mood: "mischief"
      };
    }
  }

  // Default idle
  return {
    art: art[`${cat.stage}_idle`] || art.kitten_idle,
    mood: "idle"
  };
}

/* ---------------- RENDER ---------------- */
function render() {
  const screenTop = document.getElementById("screen-top");
  const screenBottom = document.getElementById("screen-bottom");
  const stats = document.getElementById("stats");

  const { art: artState, mood } = getMoodAndArt();

  // Wrap cat art in current environment
  const envWrapper = surroundings[cat.environment] || surroundings.floor;
  const wrapped = envWrapper(artState);
  screenTop.innerHTML = "<pre>" + wrapped + "</pre>";

  // Mini-game UI override
  if (game.active) {
    const secondsLeft = Math.max(0, Math.ceil((game.endTime - Date.now()) / 1000));
    screenBottom.textContent =
      "Mini-game: Mash PLAY!\n" +
      "Score: " + game.score + "   Time: " + secondsLeft + "s";
  } else if (!cat.alive) {
    screenBottom.textContent = cat.name + " is gone...";
  } else if (cat.isNapping) {
    screenBottom.textContent = cat.name + " is napping peacefully...";
  } else {
    const stageDialog = dialog[cat.stage] || dialog.kitten;
    const lines = stageDialog[mood] || stageDialog.idle || dialog.kitten.idle;
    screenBottom.textContent = randomChoice(lines);
  }

  stats.textContent =
    `Hunger:      ${cat.hunger}
Energy:      ${cat.energy}
Happiness:   ${cat.happiness}
Cleanliness: ${cat.cleanliness}
Sick:        ${cat.sick ? "YES" : "NO"}
Age:         ${cat.ageDays} days
Stage:       ${cat.stage}
Personality: ${cat.personality}
Env:         ${cat.environment}${cat.environmentAuto ? " (auto)" : ""}`;

  const disableActions = cat.isNapping || !cat.alive || game.active;
  document.getElementById("feed").disabled = disableActions;
  document.getElementById("play").disabled = !cat.alive;
  document.getElementById("clean").disabled = disableActions;
  document.getElementById("med").disabled = disableActions;
  document.getElementById("game").disabled = !cat.alive || game.active;

  document.getElementById("nap").textContent = cat.isNapping ? "Wake" : "Nap";
  document.getElementById("nap").disabled = !cat.alive || game.active;
  document.getElementById("env").disabled = !cat.alive || game.active;
}

/* ---------------- PERSONALITY HELPERS ---------------- */
function applyPersonalityModifiers(action, deltas) {
  const p = cat.personality;
  const result = {...deltas};

  if (p === "lazy") {
    if (action === "nap") result.energy = Math.round(result.energy * 1.3);
    if (action === "play") result.energy = Math.round(result.energy * 1.2);
  }

  if (p === "playful") {
    if (action === "play") result.happiness = Math.round(result.happiness * 1.4);
  }

  if (p === "grumpy") {
    if (action === "clean") result.happiness = Math.round(result.happiness * 1.4 * -1);
    if (action === "feed") result.happiness = Math.round(result.happiness * 0.7);
  }

  if (p === "needy") {
    if (action === "play" || action === "feed" || action === "clean") {
      result.happiness = Math.round(result.happiness * 1.2);
    }
  }

  return result;
}

/* ---------------- TIME DECAY + NAP RECOVERY ---------------- */
function clamp() {
  ["hunger","energy","happiness","cleanliness"].forEach(k => {
    cat[k] = Math.max(0, Math.min(100, cat[k]));
  });
}

function checkAlive() {
  if (cat.hunger <= 0 || cat.energy <= 0 || cat.happiness <= 0) {
    if (cat.alive) {
      logMsg(cat.name + " has passed away...");
      beep(200, 400);
    }
    cat.alive = false;
    cat.isNapping = false;
    cat.napStart = null;
    if (game.active) {
      clearInterval(game.timerId);
      game.active = false;
    }
  }
}

function sicknessCheck() {
  if (cat.hunger > 95 || cat.cleanliness < 10 || cat.energy < 5) {
    if (!cat.sick) {
      cat.sick = true;
      logMsg(cat.name + " has become sick.");
      beep(400, 200);
    }
  }
}

function applyTimeDecay() {
  const now = Date.now();
  const diffMinutes = Math.floor((now - cat.lastCheck) / (1000 * 60));
  if (diffMinutes <= 0) {
    updateAge();
    return;
  }

  let chunks = Math.floor(diffMinutes / DECAY_CHUNK_MINUTES);
  if (chunks < 1) chunks = 1;

  // Regular decay only when not napping and alive
  if (!cat.isNapping && cat.alive) {
    cat.hunger -= 4 * chunks;
    cat.energy -= 3 * chunks;
    cat.cleanliness -= 3 * chunks;
    cat.happiness -= 3 * chunks;
  }

  // Nap recovery + drains
  if (cat.isNapping && cat.napStart && cat.alive) {
    const napMinutes = Math.floor((now - cat.napStart) / (1000 * 60));
    if (napMinutes > 0) {
      const energyGain = napMinutes * 5;   // +5 per minute
      const hungerDrain = napMinutes * 1;  // -1 per minute
      const cleanDrain  = napMinutes * 2;  // -2 per minute

      cat.energy += energyGain;
      cat.hunger -= hungerDrain;
      cat.cleanliness -= cleanDrain;

      cat.napStart = now;

      logMsg(
        `${cat.name} slept for ${napMinutes} min: +${energyGain} energy, -${hungerDrain} hunger, -${cleanDrain} cleanliness.`
      );

      if (cat.energy >= 100) {
        cat.energy = 100;
        cat.isNapping = false;
        logMsg(cat.name + " wakes up fully rested.");
        beep(900, 120);
      }
    }
  }

  cat.lastCheck = now;
  clamp();
  sicknessCheck();
  checkAlive();
  updateAge();
}

/* ---------------- ACTIONS ---------------- */
function actFeed() {
  if (!cat.alive || game.active) return;

  let deltas = { hunger: +18, energy: 0, happiness: +4, cleanliness: 0 };
  deltas = applyPersonalityModifiers("feed", deltas);

  cat.hunger += deltas.hunger;
  cat.energy += deltas.energy;
  cat.happiness += deltas.happiness;

  clamp();
  logMsg("You feed " + cat.name + ". Tiny crunches echo in the void.");
  beep(900, 80);
  sicknessCheck();
  tick();
}

function actPlay() {
  if (!cat.alive) return;

  // Mini-game button
  if (game.active) {
    game.score += 1;
    beep(1100, 60);
    render();
    return;
  }

  let deltas = { hunger: -5, energy: -12, happiness: +15, cleanliness: 0 };
  deltas = applyPersonalityModifiers("play", deltas);

  cat.hunger += deltas.hunger;
  cat.energy += deltas.energy;
  cat.happiness += deltas.happiness;

  clamp();
  logMsg(cat.name + " goes wild with zoomies.");
  beep(1000, 80);
  sicknessCheck();
  tick();
}

function actClean() {
  if (!cat.alive || game.active) return;

  let deltas = { hunger: 0, energy: 0, happiness: -4, cleanliness: +25 };
  deltas = applyPersonalityModifiers("clean", deltas);

  cat.hunger += deltas.hunger;
  cat.energy += deltas.energy;
  cat.happiness += deltas.happiness;
  cat.cleanliness += deltas.cleanliness;

  clamp();
  logMsg("You clean " + cat.name + ". It looks better, but clearly resents it.");
  beep(850, 80);
  sicknessCheck();
  tick();
}

function actNap() {
  if (!cat.alive || game.active) return;

  // Cancel nap if already napping
  if (cat.isNapping) {
    cat.isNapping = false;
    cat.napStart = null;
    logMsg(cat.name + " wakes up early from the nap.");
    beep(950, 120);
    clamp();
    sicknessCheck();
    tick();
    return;
  }

  cat.isNapping = true;
  cat.napStart = Date.now();

  let deltas = { hunger: -3, energy: 0, happiness: +3, cleanliness: 0 };
  deltas = applyPersonalityModifiers("nap", deltas);

  cat.hunger += deltas.hunger;
  cat.happiness += deltas.happiness;

  clamp();
  sicknessCheck();
  logMsg(cat.name + " curls up and begins a long nap.");
  beep(700, 80);
  tick();
}

function actMed() {
  if (!cat.alive || game.active) return;

  if (!cat.sick) {
    logMsg(cat.name + " doesn't need medicine right now.");
    return;
  }

  cat.sick = false;
  cat.happiness = Math.min(100, cat.happiness + 10);
  logMsg("You give " + cat.name + " medicine. It looks better already.");
  beep(1100, 120);
  tick();
}

function changeEnvironmentManual() {
  if (!cat.alive || game.active) return;

  const options = ["floor", "bed", "tower", "window", "box", "blanket"];
  const currentIndex = options.indexOf(cat.environment);
  const nextEnv = options[(currentIndex + 1) % options.length];

  cat.environment = nextEnv;
  cat.environmentAuto = false; // manual override from now on
  logMsg(cat.name + " moves to the " + nextEnv + ".");
  beep(800, 80);
  save();
  render();
}

/* ---------------- MINI-GAME ---------------- */
function startMiniGame() {
  if (!cat.alive || game.active || cat.isNapping) return;

  game.active = true;
  game.score = 0;
  game.endTime = Date.now() + 10000; // 10 seconds

  logMsg("Mini-game started! Mash PLAY to cheer up " + cat.name + "!");
  beep(1200, 100);

  if (game.timerId) clearInterval(game.timerId);
  game.timerId = setInterval(() => {
    if (!game.active) {
      clearInterval(game.timerId);
      return;
    }
    if (Date.now() >= game.endTime) {
      endMiniGame();
    } else {
      render();
    }
  }, 150);

  render();
}

function endMiniGame() {
  if (!game.active) return;

  game.active = false;
  clearInterval(game.timerId);

  const rewardHappiness = Math.min(30, game.score * 2);
  const costEnergy = Math.min(20, Math.floor(game.score / 2));

  cat.happiness = Math.min(100, cat.happiness + rewardHappiness);
  cat.energy = Math.max(0, cat.energy - costEnergy);

  clamp();
  logMsg(
    `Mini-game over! Score: ${game.score}. ` +
    `Happiness +${rewardHappiness}, Energy -${costEnergy}.`
  );
  beep(900, 140);
  sicknessCheck();
  tick();
}

/* ---------------- TICK & INIT ---------------- */
function tick() {
  cat.lastCheck = Date.now();
  clamp();
  checkAlive();
  updateAge();
  save();
  render();
}

function startGame() {
  cat.name = document.getElementById("name-input").value.trim() || "Mochi";
  cat.personality = document.getElementById("personality-select").value;
  cat.hunger = 50;
  cat.energy = 50;
  cat.happiness = 50;
  cat.cleanliness = 50;
  cat.sick = false;
  cat.alive = true;
  cat.isNapping = false;
  cat.napStart = null;
  cat.birth = Date.now();
  cat.ageDays = 0;
  cat.stage = "kitten";
  cat.lastBirthdayNotified = -1;
  cat.lastCheck = Date.now();
  cat.environmentAuto = true;
  cat.environment = getPreferredEnvironment();

  if (game.timerId) clearInterval(game.timerId);
  game.active = false;
  game.score = 0;

  save();
  render();
  logMsg(cat.name + " wakes up in the tiny screen.");
  beep(1000, 100);
}

/* Buttons */
document.getElementById("start-btn").onclick = startGame;
document.getElementById("feed").onclick = actFeed;
document.getElementById("play").onclick = actPlay;
document.getElementById("clean").onclick = actClean;
document.getElementById("nap").onclick = actNap;
document.getElementById("med").onclick = actMed;
document.getElementById("game").onclick = startMiniGame;
document.getElementById("env").onclick = changeEnvironmentManual;

/* Load previous state */
load();
applyTimeDecay();

if (history.length > 0) {
  document.getElementById("log").innerHTML = history.join("<br>");
}

render();
</script>

</body>
</html>
